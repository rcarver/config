# Secrets

Config provides a system for storing sensitive information in the
project repository. Broadly we call this information "secrets".

In order to store sensitive information within the project, it must be
encrypted. Once encrypted, it can be decrypted at runtime in order to be
used on the node.

## Workflow

Dealing with sensitive information doesn't need to be hard. Config
supports it natively in order to reduce the pain as much as possible.
The workflow:

  1. Generate a master secret.
  2. Optionally, configure settings for derived keys generation.
  3. Encrypt sensitive information and add it to your configuration.
  4. Decrypt and use secrets at runtime.

## Generate a master secret

First generate a master secret. The master secret is used to generate
other secrets.

    bin/config-create-master-secret

The result of this command is a file at `.data/secret-key-master`.
Config can now generate one or more shared secrets using the master.

## Derived keys

Config generates one or more keys to encrypt your data using the master
secret. You may configure how these keys are generated by altering the
`secrets` configuration. The default configuration is as follows.

    # config.rb
    configure :secrets,
      salt: "default",
      iterations: 10_000,
      key_length: 512

In most cases this is adequate. If your preferences differ, simply
change the settings in `config.rb`. Or, to reduce the exposure of
sensitive data if one key is compromised you may change the settings
for each cluster.

    # clusters/prod.rb
    configure :secrets,
      salt: "prod"

## Partitions

Any time you edit the encryption settings, Config generates a new
`partition` to store the secrets. The partition is a SHA1 hash of all of
the settings. You generally don't need to worry about the partition, but
you may see it exposed from time to time.

## Encrypt

Use `config-encrypt` to encrypt a value you would like to keep secret.

    bin/config-encrypt $AWS_SECRET_ACCESS_KEY

The result is an encrypted form of your AWS access key written to
STDOUT. Once you have encrypted the value, it's safe to store either
globally in `config.rb` or in a cluster configuration.

If the value you are encrypting is large (an SSL cert for example), pipe
it to `config-encrypt`.

    cat /tmp/example.com.cert | bin/config-encrypt

This works well with clipboard commands on the Mac.

    pbpaste | bin/config-encrypt | pbcopy

### Clusters

If you use different settings in each cluster, be sure to specify the
cluster you're encrypting for with the `-c` flag.

    bin/config-encrypt -c prod $AWS_SECRET_ACCESS_KEY

### Encrypt with syntax

To simplify adding a secret value to your configuration,
`config-encrypt` can write the code for you. Use the `-k` flag to
specify the key name.

    bin/config-encrypt -k aws_secret_access_key $AWS_SECRET_ACCESS_KEY

The result looks something like this:

    aws_secret_access_key: secret("<encrypted value>")

### Encrypt to a file

If the encrypted value is large (again, an SSL cert for example), you
may wish to store it in a file instead of as a large string.

    bin/config-encrypt -f aws_secret_access_key $AWS_SECRET_ACCESS_KEY

Instead of writing the encrypted string to STDOUT, it will be written to
a file at `secrets/<PARTITION>-aws_secret_access_key`. The output looks like
this:

    aws_secret_access_key: secret(:aws_secret_access_key)

## Decrypt

Secret values are decrypted automatically at runtime. Config knows that
a value should be decrypted when you set it using the `secret` helper.

  configure :amazon,
    aws_secret_access_key: secret("<encrypted aws key>")

If the value is stored in a file, pass a Symbol naming the file.

  configure :amazon,
    aws_secret_access_key: secret(:aws_secret_access_key)

Decryption is done using the settings defined by the current
configuration level.

## Secrets and nodes

In order to decrypt secrets, each node must have access to the partition
key(s). To do this, the node must either have a copy of the master
secret or the derived partition key. Since distributing the master
secret would expose all possible derived secrets, Config instead only
distributes the derived partition keys used by the node.

Key distribution is done when a node is bootstrapped. Doing so means
that the node has no dependence on a key server or the like. However,
because the keys are only updated at bootstrap it's important to decide
up front on the encryption settings for a cluster.

TODO: how would secrets rotation work? It should be possible to
redistribute keys without necessarily re-bootstrapping a node.

## Examples

Following is an example to demonstrate the secrets workflow.

  1. Generate a master secret.

        bin/config-create-master-secret

  2. Edit base encryption settings (optional).

        # config.rb
        configure :secrets,
          key_length: 128,
          salt: "XXYYZZ"

  3. Encrypt a secret.

        bin/config-encrypt $AWS_SECRET_ACCESS_KEY

        # config.rb
        configure :aws,
          secret_access_key: secret("<encrypted string>")

  4. Use different settings in the production cluster.

        # clusters/prod.rb
        configure :secrets,
          key_length: 1024,
          salt: "AABBCC"

  5. Encrypt a secret for production.

        bin/config-encrypt -c prod $AWS_SECRET_ACCESS_KEY

        # config.rb
        configure :aws,
          secret_access_key: secret("<encrypted string>")


